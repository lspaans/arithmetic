<!DOCTYPE html>
<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <script>
            var [MAX_GAME_ROUNDS, THRESHOLD] = [10, 10];

            var [max_game_rounds, exercises] = [MAX_GAME_ROUNDS, []];
            var [wrong, right, game_round] = [0, 0, 0];
            var [num1, num2, result] = [null, null, null];

            Array.prototype.isEqual = function(that) {
                if (this.length != that.length) {
                    return false;
                };

                if (this.every(function(v, i) {return v === that[i]})) {
                    return true;
                };

                return false;
            };

            var Cache = function() {
                this.store = [];
            };

            Cache.prototype.contains = function(arr) {
                for(var i=0; i < this.store.length; i++) {
                    if (this.store.isEqual(arr)) {
                        return true;
                    };
                };

                return false;
            };

            Cache.prototype.append = function(arr) {
                if (!this.contains(arr)) {
                    this.store.push(arr);
                };
            };

            var Exercise = function(threshold) {
                this.cache = new Cache();

                if (typeof(threshold) === "undefined") {
                    this.threshold = THRESHOLD;
                } else {
                    this.threshold = threshold;
                };
            };

            Exercise.prototype.get_details = function() {
                var [num1, num2] = [this.get_number(), this.get_number()];

                while (this.cache.contains([num1, num2].sort())) {
                    [num1, num2] = [this.get_number(), this.get_number()];
                };

                this.cache.append([num1, num2].sort());

                if (num2 > num1) {
                    [num1, num2] = [num2, num1];
                };

                return [num1, num2, eval(num1 + this.operator + num2)];
            };

            Exercise.prototype.get_number = function() {
                  return Math.floor(this.threshold * Math.random()) + 1;
            };

            function Addition(threshold) {
                Exercise.call(this);
                this.operator = "+";
                this.display_operator = "+";
            };

            Addition.prototype = new Exercise();

            function Subtraction(threshold) {
                Exercise.call(this);
                this.operator = "-";
                this.display_operator = "-";
            };

            Subtraction.prototype = new Exercise();

            function Multiplication(threshold) {
                Exercise.call(this);
                this.operator = "*";
                this.display_operator = "x";
            };

            Multiplication.prototype = new Exercise();

            function Division(threshold) {
                Exercise.call(this);
                this.operator = "/";
                this.display_operator = "/";
            };

            Division.prototype = new Exercise();

            Division.prototype.get_details = function() {
                var [num1, num2] = [this.get_number(), this.get_number()];

                while (this.cache.contains([num1, num2].sort())) {
                    [num1, num2] = [this.get_number(), this.get_number()];
                };

                this.cache.append([num1, num2].sort());

                if (num2 > num1) {
                    [num1, num2] = [num2, num1];
                };

                return [num1 * num2, num2, num1];
            };

            var get_motivational_message = function() {
                percentage_right = Math.round((100 / max_game_rounds) * right);

                var overview = (
                    "Je hebt er " + right + " van de " +
                    max_game_rounds + " goed!"
                );

                if (percentage_right == 100) {
                    return "Fantastisch! Je hebt ALLES goed Slimpie!";
                } else if (percentage_right > 80) {
                    return "Supernetjes! " + overview;
                } else if (percentage_right > 60) {
                    return "Goed gedaan hoor! " + overview;
                } else if (percentage_right > 40) {
                    return "Helaas, net geen voldoende! :-( " + overview;
                } else if (percentage_right > 20) {
                    return "Volgende keer beter! " + overview;
                };

                return "Jammer, niets goed. Blijf oefenen!";
            }

            var do_round = function() {
                if (
                    game_round > 0 &&
                    right + wrong < max_game_rounds
                ) {
                    if ($("input[name='answer']:last").val() == result) {
                        right++;
                    } else {
                        wrong++;
                    };
                };

                if (game_round >= max_game_rounds) {
                    $("#statistics").text(
                        "Je hebt " + right + " goed en " + wrong + " fout."
                    );

                    $("div[name='round']:last").hide();

                    $("<div/>", {
                        "class": "box",
                        "id": "score",
                        "name": "score",
                        text: get_motivational_message()
                    }).appendTo("body");

                    $("<button/>", {
                        "class": "button",
                        "name": "reload",
                        "onClick": "window.location.reload();",
                        "text": "Opnieuw"
                    }).appendTo("div[name='score']");

                    return;
                };

                game_round++;

                $("#statistics").text(
                    "Ronde " + game_round + " van " + max_game_rounds + " â€” " +
                    "je hebt " + right + " goed en " + wrong + " fout."
                );

                var exercise = exercises[
                    Math.floor(exercises.length * Math.random())
                ];

                [num1, num2, result] = exercise.get_details();

                $("div[name='round']:last").hide();

                $("<div/>", {
                    "class": "box",
                    "id": "round" + game_round,
                    "name": "round",
                    text: (
                        "Hoeveel is " +
                        num1 + " " + exercise.display_operator + " " + num2 +
                        " ?"
                    )
                }).appendTo("body");

                $("<input/>", {
                    "class": "input",
                    "id": "answer" + game_round,
                    "name": "answer"
                }).appendTo("div[name='round']:last");

                $("input[name='answer']:last").on('keyup', function (event) {
                    if (!has_only_numbers()) {
                        return;
                    };

                    if (event.keyCode == 13) {
                        do_round();
                    };
                });

                $("input[name='answer']:last").focus();

                $("<button/>", {
                    "class": "button",
                    "name": "submit",
                    "text": "Controleer"
                }).appendTo("div[name='round']:last");

                $("button[name='submit']").on('click', function () {
                    if (!has_only_numbers()) {
                        return;
                    };

                    do_round();
                });
            };

            var init_game = function() {
                if (typeof(max_game_rounds) === "undefined") {
                    max_game_rounds = MAX_GAME_ROUNDS;
                };

                $("<span/>", {
                    "class": "box title",
                    "text": "Rekenen"
                }).appendTo("body");

                [game_round, wrong, right] = [0, 0, 0];
                exercises = [
                    new Addition(),
                    new Subtraction(),
                    new Multiplication(),
                    new Division()
                ];

                $("<div/>", {
                    "class": "box",
                    "id": "statistics",
                    "name": "statistics"
                }).appendTo("body");

                do_round();
            };

            var has_only_numbers = function() {
                return $("input[name='answer']:last").val().match(/^\d+$/);
            };

            $(document).ready(init_game);
        </script>
        <style>
            body {
                background: linear-gradient(to right, purple , red);
                width: 1280px;
            }
            .box {
                background: rgb(0, 0 ,0);
                border-radius: 15px;
                border: 2px solid rgb(255, 255, 255);
                color: rgb(255, 255, 255);
                display: block;
                font-family: "Arial Black";
                font-size: 24pt;
                margin: 0% 5% 5% 5%;
                padding: 1em;
            }
            .button {
                background: rgb(255, 255, 0);
                color: rgb(0, 0, 255);
                font-family: "Arial Black";
                text-shadow: 2px 2px rgb(160, 160, 160);
                font-size: 24pt;
                margin: 0% 0% 0% 5%;
                float: right;
            }
            .input {
                border: 2px solid rgb(255, 255, 255);
                color: rgb(80, 0, 80);
                font-family: "Arial Black";
                font-size: 24pt;
                margin-left: 5%;
                padding-left: 1%;
                width: 30%;
            }
            .title {
                background: linear-gradient(to right, blue , yellow);
                border-radius: 15px;
                color: white;
                font-weight: bold;
                font-size: 48pt;
                padding: 1%;
                text-align: center;
            }
        </style>
        <title>::: Rekenen :::</title>
    </head>
    <body/>
</html>
